CDH 5.x 升级到 CDH 6.x
====
完整升级过程因为每个升级环境的不同，需要的步骤可能也会有差别，比如升级时有些可能会升级系统环境、升级JDK、升级源数据库、迁移节点等，
升级面对的各种情况官方提供的资料很完整，可以查看官方文档 [Upgrading CDH](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cdh_upgrading_top.html)。

本次升级主要是为了升级CDH中的Impala、
[Kudu](https://www.cloudera.com/documentation/enterprise/5-16-x/topics/kudu_install_upgrade_intro.html#hive_guide_install_upgrade_intro)、Kafka等几个组建，
因为从某些版本开始，因为需要基于 `parcel-based configuration` 已经不是单独的parcel了，而是捆绑到`CDH package`。因此需要升级`Cloudera Management Service` 到需要的版本，然后再升级组建服务。
```
Apache Impala, Apache Kudu, Apache Spark 2, and Cloudera Search are included in the CDH parcel. 
To download the files for the latest CDH 6.2 release.
```

以下只记录重要的步骤，将CDH从5.16.1 升级到6.2.0。  
[CDH 6.2.0 Packaging](https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_62_packaging.html) | 
[Incompatible Changes in CDH 6.2.0](https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_cdh_620_incompatible_changes.html#spark_ic_620)

# 1 收集信息
## 1.1 查看 Manager Server 服务器系统版本
查看服务器系统版本，查看要升级的版本是否支持当前的系统，如果升级系统，需要先升级系统。 
[Cloudera Enterprise 6 Requirements and Supported Versions](https://www.cloudera.com/documentation/enterprise/6/release-notes/topics/rg_requirements_supported_versions.html#cm_cdh_compatibility)

登陆 Manager Server host

执行如下命令
```
[root@cdh1 ~]# lsb_release -a
LSB Version:    :core-4.1-amd64:core-4.1-noarch
Distributor ID: CentOS
Description:    CentOS Linux release 7.4.1708 (Core)
Release:        7.4.1708
Codename:       Core
```

## 1.2 查看其他信息
登陆 Cloudera Manager 管理控制台：
* 群集中使用的Cloudera Manager版本。转到支持 > 关于。
* 集群中部署的JDK版本。转到支持 > 关于。
* CDH是否启用了高可用。转到HDFS服务，点击`操作`按钮，如果看到`禁用高可用性`，则集群已启用高可用性。


# 2 准备升级
1. 您必须具有对Cloudera Manager服务器主机的SSH访问权限，并且能够使用root帐户或对所有主机具有无密码sudo权限的帐户登录。
2. 如果升级是需要升级操作系统，先升级操作系统
3. 确保在群集中安装了Java 1.7或1.8。Cloudera Manager 6.0.0及更高版本和CDH 6.0.0及更高版本需要Java 1.8。
4. 查看文档：[CDH 5发行说明](http://www.cloudera.com/content/cloudera/en/documentation/core/latest/topics/rg_release_notes_cdh.html)、
[Cloudera安全公告](https://www.cloudera.com/documentation/other/security-bulletins/topics/Security-Bulletin.html)
5. 查看升级过程并预留维护时段，并指定足够的时间来执行所有步骤。对于生产群集，Cloudera建议分配至少一整天的维护时段来执行升级，具体取决于主机数量，
Hadoop和Linux的使用经验以及您使用的特定硬件。
6. 如果群集使用Impala，请根据[不兼容的更改中](https://www.cloudera.com/documentation/enterprise/upgrade/topics/rg_cdh_600_incompatible_changes.html#impala_incompatible_changes_c6b1)
列出的最新保留字检查SQL 。如果要跨多个版本升级，或者遇到任何问题，请检查[Impala关键字](https://www.cloudera.com/documentation/enterprise/upgrade/topics/impala_reserved_words.html#reserved_words)的完整列表 。
7. 运行安全检查器并修复任何报告的错误。点击 `管理 > 安全性 > 安全性检查器`
8. 以`hdfs`用户登录任何集群节点，运行以下命令，并更正任何报告的错误：`$ hdfs fsck / -includeSnapshots` 、`$ hdfs dfsadmin -report`
9. 在任意 DataNode 节点以`hdfs`用户登录，行以下命令，并更正任何报告的错误：`$ hbase hbck`
10. 如果群集使用Kudu，请登录到群集任何主机以`kudu` 用户（sudo -u kudu）并运行 `ksck` 命令 。  `kudu cluster ksck master_ip:7051`
11. 如果您的群集使用Sentry和Oracle数据库，并且您要从CDH 5.13.0或更高版本升级到CDH 5.16.0或更高版本，
则必须手动添加`AUTHZ_PATH.AUTHZ_OBJ_ID`索引（如果该索引尚不存在）。手动添加索引会减少Sentry为获取HDFS同步的完整快照所需的时间。
使用以下命令添加索引：`CREATE INDEX "AUTHZ_PATH_FK_IDX" ON "AUTHZ_PATH" ("AUTHZ_OBJ_ID");`
12. 打开Cloudera Manager管理控制台并收集有关您的环境的以下信息，
13. 在开始升级之前备份Cloudera Manager。请参阅[备份Cloudera Manager](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_backup.html#ug_cm_upgrade_backup)。

# 3 备份Cloudera Manager
Cloudera建议您在升级之前执行这些备份步骤。备份将允许您根据需要回滚Cloudera Manager升级。

## Step 1: 收集备份Cloudera Manager的信息
1. 登录Cloudera Manager Server主机
2. 通过运行以下命令收集数据库信息：
    ```
    [root@cdh1 ~]# cat /etc/cloudera-scm-server/db.properties
    # Auto-generated by scm_prepare_database.sh on Thu Apr 25 09:47:50 CST 2019
    #
    # For information describing how to configure the Cloudera Manager Server
    # to connect to databases, see the "Cloudera Manager Installation Guide."
    #
    com.cloudera.cmf.db.type=mysql
    com.cloudera.cmf.db.host=localhost
    com.cloudera.cmf.db.name=scm
    com.cloudera.cmf.db.user=scm
    com.cloudera.cmf.db.setupType=EXTERNAL
    com.cloudera.cmf.db.password=scm
    ```
3. 收集以下数据库的信息（主机名，端口号，数据库名，用户名和密码）
    * Reports Manager
    * Navigator Audit Server
    * Navigator Metadata Server
    * Activity Monitor  
    群集 > Cloudera管理服务 > 配置，然后在左侧类别中分别选择上面几个对应的服务，查看**数据库**信息。您可能需要与数据库管理员联系以获取密码。
4. 找到运行Service Monitor，Host Monitor和Event Server角色的主机。转到`群集 > Cloudera Management Service > 实例`并记下哪些主机正在运行这些角色。
5. 确定Cloudera Navigator Metadata Server存储目录的位置：
    ```
    转到群集 > Cloudera Management Service > 实例。
    单击“ 配置”选项卡。
    选择 Scope > Navigator Metadata Server。
    该 Navigator Metadata Server Storage Dir 属性存储目录的位置。`nav.data.dir : /var/lib/cloudera-scm-navigator`
    ```
6. 确保Navigator Metadata Server Java堆足够大以完成升级。 
    ```
    集群 > Cloudera Management Service > 实例.
    在实例列表中，单击 Navigator Metadata Server.
    选择日志文件 > 角色日志文件。
    搜索日志文件 solr core nav_elements 并注意元素文档的数量。
    搜索日志文件 solr core nav_relations 并注意关系文件的数量。
    将每个文档的文档总数乘以200个字节，并为其添加2 GB的基线：
    `((num_nav_elements + num_nav_relations) * 200 bytes) + 2 GB`
        例如，如果您有68813088个元素和78813930关系，建议的Java堆大小约为30 GB：
        `((68813088 + 78813930) * 200) + 2 GB = 29525403600 bytes = ~29.5 GB + 2 GB = ~ 31.5 GB`
    在Clusters > Cloudera Management Service > Configuration中以字节为单位在Navigator Metadata Server的Java堆大小中设置堆值。
    ```

## Step 2: 备份Cloudera Manager Agent
在所有主机上备份以下Cloudera Manager Agent 文件：
* 创建顶级备份目录。
```bash
export CM_BACKUP_DIR="`date +%F`-CM"
echo $CM_BACKUP_DIR
mkdir -p $CM_BACKUP_DIR
```

* 备份代理目录和运行时状态。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-agent.tar --exclude=*.sock /etc/cloudera-scm-agent /etc/default/cloudera-scm-agent /var/run/cloudera-scm-agent /var/lib/cloudera-scm-agent
```

* 备份现有的存储库目录。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/repository.tar /etc/yum.repos.d
```

## Step 3: 备份 Cloudera Management Service
* 在配置Service Monitor角色的主机上，备份以下目录：(会在`/var/lib/`生产备份目录)
```bash
sudo cp -rp /var/lib/cloudera-service-monitor /var/lib/cloudera-service-monitor-`date +%F`-CM
```

* 在Host Monitor角色配置为运行的主机上，备份以下目录：(会在`/var/lib/`生产备份目录)
```bash
sudo cp -rp /var/lib/cloudera-host-monitor /var/lib/cloudera-host-monitor-`date +%F`-CM
```

* 在将Event Server角色配置为运行的主机上，备份以下目录：
```bash
sudo cp -rp /var/lib/cloudera-scm-eventserver /var/lib/cloudera-scm-eventserver-`date +%F`-CM
```

## Step 4: 备份Cloudera Navigator数据

* 确保最近运行清除任务以清除过时和已删除的实体。
    + 您可以在Cloudera Navigator控制台中查看上次清除任务的时间（从Cloudera Manager管理控制台，转到 集群 > Cloudera Navigator，选择Administration > Purge Settings。）
    + 如果最近未运行清除，请通过编辑同一页面上的清除计划来运行清除。
    + 设置清除过程选项以清除尽可能多的积压数据，因为您可以容忍升级后的系统。请参阅使用清除管理元数据存储。

* 停止Navigator Metadata Server。
    群集 > Cloudera Management Service > 实例，选择Navigator Metadata Server，单击所选的操作 > 停止

* 备份Cloudera Navigator Solr存储目录。
```bash
sudo cp -rp /var/lib/cloudera-scm-navigator /var/lib/cloudera-scm-navigator-`date +%F`-CM
```

## Step 5: 停止Cloudera Manager Server和Cloudera Management Service
* 停止 `Cloudera Management Service`。通过页面 `Clusters > Cloudera Management Service` 操作 > 停止

* 登录Cloudera Manager Server主机

* 停止Cloudera Manager Server。
```bash
sudo systemctl stop cloudera-scm-server

# 或者
/opt/cm-5.16.1/etc/init.d/cloudera-scm-server stop
# 此时也可以提前顺便将 agent 停止，不过后面的步骤也会停止
/opt/cm-5.16.1/etc/init.d/cloudera-scm-agent stop
```

## Step 6: 备份Cloudera Manager数据库
备份 `Cloudera Manager server` database - 运行以下命令。
（下面显示的命令取决于您在本页顶部的表单中选择的数据库。将占位符替换为从db.properties 文件）：
```bash
mysqldump --databases database_name --host=database_hostname --port=database_port -u user_name -p > $HOME/database_name-backup-`date +%F`-CM.sql
```

备份**All other Cloudera Manager databases** - 使用您在上一步中收集的数据库信息。
    + Reports Manager
    + Navigator Audit Server
    + Navigator Metadata Server
    + Activity Monitor (Only used for MapReduce 1 monitoring).
运行以下命令以备份数据库。（下面显示的命令取决于您在本页顶部的表单中选择的数据库。将占位符替换为实际值。）：
```bash
mysqldump --databases database_name --host=database_hostname --port=database_port -u database_username -p > $HOME/database_name-backup-`date +%F`-CM.sql
```

例如这里需要备份的库有： `amon、hive、hue、oozie、rman、scm`
```bash
## 一次替换执行如下命令
mysqldump --databases amon --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/amon-backup-`date +%F`-CM.sql
mysqldump --databases hive --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/hive-backup-`date +%F`-CM.sql
mysqldump --databases hue --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/hue-backup-`date +%F`-CM.sql
mysqldump --databases oozie --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/oozie-backup-`date +%F`-CM.sql
mysqldump --databases rman --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/rman-backup-`date +%F`-CM.sql
mysqldump --databases scm --host=cdh1 --port=3306 -u root -p > $CM_BACKUP_DIR/scm-backup-`date +%F`-CM.sql
```

## Step 7: 备份Cloudera Manager Server
* 登录Cloudera Manager Server主机。

* 创建顶级备份目录。
```bash
export CM_BACKUP_DIR="`date +%F`-CM"
echo $CM_BACKUP_DIR
mkdir -p $CM_BACKUP_DIR
```

* 备份Cloudera Manager Server目录：
```bash
sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-server.tar /etc/cloudera-scm-server /etc/default/cloudera-scm-server
```

* 备份现有的存储库目录。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/repository.tar /etc/yum.repos.d
```

## Step 8: （可选）启动Cloudera Manager Server和Cloudera Management Service
启动Cloudera Manager服务器和Cloudera Manager Management服务。

如果要立即升级Cloudera Manager，请跳过此步骤并继续[升级Cloudera Manager Server](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_server.html#ug_cm_upgrade_server)。

1. 登录Cloudera Manager Server主机。 
2. 启动Cloudera Manager Server。   
    ```bash
    sudo systemctl start cloudera-scm-server 
    # 或者
    /opt/cm-5.16.1/etc/init.d/cloudera-scm-server start
    ```
3. 启动 Cloudera Management Service。  


# 4 升级 Cloudera Manager Server

## Step 1: 建立对软件的访问权限
* 登录Cloudera Manager Server主机

* 删除现有存储库目录中的所有旧文件：
```bash
sudo rm /etc/yum.repos.d/cloudera*manager.repo*
```

* 创建存储库文件，以便包管理器可以找到并下载二进制文件：
创建一个名为的文件 `/etc/yum.repos.d/cloudera-manager.repo` 具有以下内容：
```bash
[cloudera-manager]
name=Cloudera Manager 6.2.0
baseurl=https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/
gpgkey=https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/RPM-GPG-KEY-cloudera
gpgcheck=1
enabled=1
autorefresh=0
type=rpm-md
```

* Cloudera Manager升级可以引入新的包依赖关系。您的组织可能有限制或需要事先批准安装新软件包。您可以确定可以安装或升级的软件包：
```bash
# 查看依赖列表
yum deplist cloudera-manager-agent
```

## Step 2: 装JDK 8
在Cloudera Manager 6.0.0或更高版本管理的所有群集主机上都需要Oracle JDK 1.8。如果主机上已安装JDK 1.8，请跳过本节中的步骤。

编辑 `/etc/default/cloudera-scm-server` 文件，添加 JDK 路径，保存
```bash
export JAVA_HOME="/usr/java/jdk1.8.0_141-cloudera"
```

这部分可以参考我的一篇博客 [**CDH之JDK 版本升级为 Open JDK1.8（CDH-6.x和CDH-5.x）**](https://blog.csdn.net/github_39577257/article/details/91562909)

## Step 3: 升级Cloudera Manager Server
* 登录Cloudera Manager Server主机

* 停止 Cloudera Management Service。 

* 确保已禁用任何计划的复制或快照作业，并等待Cloudera Manager Admin Console中的任何正在运行的命令完成，然后再继续升级。

* 停止Cloudera Manager Server。
```bash
sudo systemctl stop cloudera-scm-server

# 或者
/opt/cm-5.16.1/etc/init.d/cloudera-scm-server stop
```

* 停止Cloudera Manager Agent。
```bash
sudo systemctl stop cloudera-scm-agent

# 或者
/opt/cm-5.16.1/etc/init.d/cloudera-scm-agent stop
```

**注意** 如果使用的是嵌入式的 PostgreSQL 数据库，需要停止这个服务：`sudo systemctl stop cloudera-scm-server-db`。
如果无法关闭时，输入如下命令
```bash
sudo service cloudera-scm-server-db next_stop_fast
sudo service cloudera-scm-server-db stop

sudo service cloudera-scm-server-db fast_stop
```

* 升级包
```bash
sudo yum clean all
sudo yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent 
```
系统可能会提示您有关配置文件的版本：
```
Configuration file '/etc/cloudera-scm-agent/config.ini'
==> Modified (by you or by a script) since installation.
==> Package distributor has shipped an updated version.
What would you like to do about it ? Your options are:
Y or I : install the package maintainer's version
N or O : keep your currently-installed version
D : show the differences between the versions
Z : start a shell to examine the situation
The default action is to keep your current version.
```

您可能会收到类似的提示 `/etc/cloudera-scm-server/db.properties`。对两个提示回答N.
系统可能会提示您接受GPG密钥。答ÿ。
```
Retrieving key from https://archive.cloudera.com/.../cm/RPM-GPG-KEY-cloudera
Importing GPG key ...
 Userid     : "Yum Maintainer <webmaster@cloudera.com>"
 Fingerprint: ...
 From       : https://archive.cloudera.com/.../RPM-GPG-KEY-cloudera
 ```

* 如果你定制了 `/etc/cloudera-scm-agent/config.ini` 文件，您的自定义文件使用扩展名重命名 而`.rpmsave` 或者 `.dpkg-old`。
将任何自定义项合并到 `/etc/cloudera-scm-agent/config.ini` 包管理器安装的文件。

* 验证您是否安装了正确的软件包。
```bash
yum list | grep 'cloudera-manager-*'
rpm -qa 'cloudera-manager-*'
```
如果有不需要的rpm服务，这里可以将其移除
```bash
rpm -e 上面命令的名字 --nodeps
```
若列出的不是逾期的版本，请重新更改`cloudera-manager.repo`，然后 `yum clean all`

**如果这里rpm -qa不能查到服务** ：
这里比较快的更新方式是，将需要更新的 RPM 包下载下来 [cloudera-manager-*](https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/RPMS/x86_64/)

然后输入如下命令更新
```
[root@cdh1 cdh-rpm]# rpm -Uvh  cloudera-manager-server-6.2.0-968826.el7.x86_64.rpm  cloudera-manager-daemons-6.2.0-968826.el7.x86_64.rpm
Preparing...                          ################################# [100%]
Updating / installing...
   1:cloudera-manager-daemons-6.2.0-96################################# [ 50%]
   2:cloudera-manager-server-6.2.0-968warning: /etc/cloudera-scm-server/db.properties created as /etc/cloudera-scm-server/db.properties.rpmnew
################################# [100%]

[root@cdh1 cdh-rpm]# rpm -Uvh --nodeps cloudera-manager-agent-6.2.0-968826.el7.x86_64.rpm
Preparing...                          ################################# [100%]
Updating / installing...
   1:cloudera-manager-agent-6.2.0-9688################################# [100%]
Created symlink from /etc/systemd/system/multi-user.target.wants/cloudera-scm-agent.service to /usr/lib/systemd/system/cloudera-scm-agent.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/supervisord.service to /usr/lib/systemd/system/supervisord.service.
```

再次查询：
```
[root@cdh1 cdh-rpm]# rpm -qa 'cloudera-manager-*'
cloudera-manager-server-6.2.0-968826.el7.x86_64
cloudera-manager-agent-6.2.0-968826.el7.x86_64
cloudera-manager-daemons-6.2.0-968826.el7.x86_64
```

* 启动Cloudera Manager Agent。
```bash
sudo systemctl start cloudera-scm-agent
```

* 启动Cloudera Manager Server。
```bash
sudo systemctl start cloudera-scm-server
```

当启动时报如下错：
```bash
[root@cdh1 cdh-rpm]# sudo systemctl start cloudera-scm-server
Job for cloudera-scm-server.service failed because start of the service was attempted too often. See "systemctl status cloudera-scm-server.service" and "journalctl -xe" for details.
To force a start use "systemctl reset-failed cloudera-scm-server.service" followed by "systemctl start cloudera-scm-server.service" again.
```

* 使用Web浏览器使用以下URL打开Cloudera Manager Admin Console：
```bash
http://cloudera_Manager_server_hostname:7180/cmf/upgrade
http://cloudera_Manager_server_hostname:7180/cmf/upgrade-wizard/welcome
```
如果在启动服务器或代理时遇到问题（例如数据库权限问题），则可以使用日志文件来解决问题：
```bash
tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log
tail -f /var/log/cloudera-scm-agent/cloudera-scm-agent.log
tail -f /var/log/messages
```

**这里有个巨坑**，如果启动时时区初始化错误，请在`/opt/cloudera/cm/bin/cm-server`文件中大概第40行添加`CMF_OPTS="$CMF_OPTS -Duser.timezone=Asia/Shanghai"` 
但还是第一次安装和升级**强烈使用CDH的rpm的oracle jdk**，如果需要更换JDK，后期安装完成之后再更改JDK。

如果上一步启动 `cloudera-scm-agent` 和 `cloudera-scm-server` 没有问题，则直接访问：
```bash
# 根据提示 重启 Cloudera Management Service
http://cloudera_Manager_server_hostname:7180/cmf/upgrade

http://cloudera_Manager_server_hostname:7180/cmf/upgrade-wizard/welcome

```


# 5 [升级 Cloudera Manager Agents](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_agent.html)
您可以使用以下两个选项之一升级代理。

## 选项1：使用Cloudera Manager升级代理（推荐）
**注意**：如果Cloudera Manager在此过程中显示与以下内容类似的错误消息，则可能是旧版本的JDK干扰了升级：
```bash
ls: cannot access '/etc/zypp/repos.d/cloudera-manager.repo.*': No such file or directory 
repository file /etc/zypp/repos.d/cloudera-manager.repo removed
```
在升级之前删除旧的JDK将允许Cloudera Manager完成升级。

Cloudera Manager Server启动并登录Cloudera Manager Admin Console后，将显示Upgrade Cloudera Manager页面。（服务器可能需要几分钟才能启动。）

如果在升级Cloudera Manager Server主机上的软件包后未显示Upgrade Cloudera Manager页面，请在Web浏览器中打开以下URL：
```bash
https://my_cloudera_manager_server_host:port/cmf/upgrade
https://my_cloudera_manager_server_host:port/cmf/upgrade-wizard/welcome
```

按照升级页面上的说明升级所有代理。


## 选项2：使用命令行升级代理
如果要从Cloudera Manager 5.5.0或更低版本升级到Cloudera Manager 5.5.0或更高版本，请在所有主机上重新启动代理以更新并重新启动 supervisord 处理。
```bash
sudo sudo systemctl stop supervisord
sudo systemctl start cloudera-scm-agent
```























